#!/bin/sh
# sqm-status: Manage and inspect sqm-autorate
# Shows service state, active/default profile, uptime, log size, and recent logs
# Allows toggling logging, log rotation, live streaming, manual clearing, verbosity levels, and combined disable/enable
# New option: "current" prints only the active profile name
# Added option: "reload" sends SIGHUP to daemon for config reload
# Added options: reflector-count, reflector-rotation-random, reflector-rotation-roundrobin, log-format toggles
# Added options: log-mode-0, log-mode-1, log-mode-2 for silent/event/tick-driven logging
# Added options: probe-min, probe-setuid-on/off, alpha-ewma

CONF=/var/sqm-autorate.conf
LOGFILE=/var/log/sqm-autorate.log
SERVICE=/etc/init.d/sqm-autorate
DEFAULT_FILE=/etc/sqm-default
PIDFILE=/var/run/sqm-autorate.pid

reload_or_restart() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if [ -n "$PID" ] && [ -d "/proc/$PID" ]; then
            kill -HUP "$PID" && echo "Sent SIGHUP to PID $PID for config reload" && return
        fi
    fi
    echo "Reload failed, restarting service..."
    $SERVICE restart
}

case "$1" in
  current)
    if [ -L "$CONF" ]; then
        ACTIVE_PATH=$(readlink -f "$CONF")
    else
        ACTIVE_PATH="$CONF"
    fi
    if [ -f "$ACTIVE_PATH" ]; then
        ACTIVE_PROFILE=$(basename "$ACTIVE_PATH" | sed 's/sqm-autorate-\(.*\)\.conf/\1/')
        echo "Active profile: $ACTIVE_PROFILE"
    else
        echo "No active profile config found"
    fi
    exit 0
    ;;
  reload)
    reload_or_restart
    exit 0
    ;;
  log-on)
    sed -i '/^log_enabled=/c\log_enabled=1' "$CONF" 2>/dev/null || echo "log_enabled=1" >> "$CONF"
    echo "Logging enabled"
    reload_or_restart
    exit 0
    ;;
  log-off)
    sed -i '/^log_enabled=/c\log_enabled=0' "$CONF" 2>/dev/null || echo "log_enabled=0" >> "$CONF"
    echo "Logging disabled"
    reload_or_restart
    exit 0
    ;;
  log-level-1)
    sed -i '/^log_level=/c\log_level=1' "$CONF" 2>/dev/null || echo "log_level=1" >> "$CONF"
    echo "Log verbosity set to LEVEL 1 (minimal)"
    reload_or_restart
    exit 0
    ;;
  log-level-2)
    sed -i '/^log_level=/c\log_level=2' "$CONF" 2>/dev/null || echo "log_level=2" >> "$CONF"
    echo "Log verbosity set to LEVEL 2 (medium)"
    reload_or_restart
    exit 0
    ;;
  log-level-3)
    sed -i '/^log_level=/c\log_level=3' "$CONF" 2>/dev/null || echo "log_level=3" >> "$CONF"
    echo "Log verbosity set to LEVEL 3 (debug)"
    reload_or_restart
    exit 0
    ;;
  log-format-compact)
    sed -i '/^log_format=/c\log_format=compact' "$CONF" 2>/dev/null || echo "log_format=compact" >> "$CONF"
    echo "Log format set to COMPACT"
    reload_or_restart
    exit 0
    ;;
  log-format-verbose)
    sed -i '/^log_format=/c\log_format=verbose' "$CONF" 2>/dev/null || echo "log_format=verbose" >> "$CONF"
    echo "Log format set to VERBOSE"
    reload_or_restart
    exit 0
    ;;
  log-format-json)
    sed -i '/^log_format=/c\log_format=json' "$CONF" 2>/dev/null || echo "log_format=json" >> "$CONF"
    echo "Log format set to JSON"
    reload_or_restart
    exit 0
    ;;
  log-mode-0)
    sed -i '/^log_mode=/c\log_mode=0' "$CONF" 2>/dev/null || echo "log_mode=0" >> "$CONF"
    echo "Log mode set to SILENT"
    reload_or_restart
    exit 0
    ;;
  log-mode-1)
    sed -i '/^log_mode=/c\log_mode=1' "$CONF" 2>/dev/null || echo "log_mode=1" >> "$CONF"
    echo "Log mode set to EVENT-DRIVEN"
    reload_or_restart
    exit 0
    ;;
  log-mode-2)
    sed -i '/^log_mode=/c\log_mode=2' "$CONF" 2>/dev/null || echo "log_mode=2" >> "$CONF"
    echo "Log mode set to TICK-DRIVEN"
    reload_or_restart
    exit 0
    ;;
  reflector-count)
    if [ -n "$2" ]; then
      sed -i "/^reflector_count=/c\reflector_count=$2" "$CONF" 2>/dev/null || echo "reflector_count=$2" >> "$CONF"
      echo "Reflector count set to $2"
      reload_or_restart
    else
      echo "Usage: $0 reflector-count <number>"
    fi
    exit 0
    ;;
  reflector-rotation-random)
    sed -i "/^reflector_rotation=/c\reflector_rotation=random" "$CONF" 2>/dev/null || echo "reflector_rotation=random" >> "$CONF"
    echo "Reflector rotation set to RANDOM"
    reload_or_restart
    exit 0
    ;;
  reflector-rotation-roundrobin)
    sed -i "/^reflector_rotation=/c\reflector_rotation=roundrobin" "$CONF" 2>/dev/null || echo "reflector_rotation=roundrobin" >> "$CONF"
    echo "Reflector rotation set to ROUNDROBIN"
    reload_or_restart
    exit 0
    ;;
  probe-min)
    if [ -n "$2" ]; then
      sed -i "/^probe_min_ms=/c\probe_min_ms=$2" "$CONF" 2>/dev/null || echo "probe_min_ms=$2" >> "$CONF"
      echo "Probe minimum interval set to $2 ms"
      reload_or_restart
    else
      echo "Usage: $0 probe-min <milliseconds>"
    fi
    exit 0
    ;;
  probe-setuid-on)
    sed -i "/^probe_setuid_fix=/c\probe_setuid_fix=1" "$CONF" 2>/dev/null || echo "probe_setuid_fix=1" >> "$CONF"
    echo "Probe setuid fix ENABLED"
    reload_or_restart
    exit 0
    ;;
  probe-setuid-off)
    sed -i "/^probe_setuid_fix=/c\probe_setuid_fix=0" "$CONF" 2>/dev/null || echo "probe_setuid_fix=0" >> "$CONF"
    echo "Probe setuid fix DISABLED"
    reload_or_restart
    exit 0
    ;;
  alpha-ewma)
    if [ -n "$2" ]; then
      sed -i "/^alpha_ewma=/c\alpha_ewma=$2" "$CONF" 2>/dev/null || echo "alpha_ewma=$2" >> "$CONF"
      echo "Latency EWMA alpha set to $2"
      reload_or_restart
    else
      echo "Usage: $0 alpha-ewma <value between 0.0 and 1.0>"
    fi
    exit 0
    ;;
  rotate-on)
    if [ -f /etc/logrotate.d/sqm-autorate.disabled ]; then
      mv /etc/logrotate.d/sqm-autorate.disabled /etc/logrotate.d/sqm-autorate
      echo "Log rotation enabled"
      logrotate -f /etc/logrotate.conf >/dev/null 2>&1
    else
      echo "Rotation config not found or already enabled"
    fi
    exit 0
    ;;
  rotate-off)
    if [ -f /etc/logrotate.d/sqm-autorate ]; then
      mv /etc/logrotate.d/sqm-autorate /etc/logrotate.d/sqm-autorate.disabled
      echo "Log rotation disabled"
    else
      echo "Rotation config not found or already disabled"
    fi
    exit 0
    ;;
  log-live)
    if [ -f "$LOGFILE" ]; then
      echo "=== LIVE LOG STREAM (Ctrl+C to stop) ==="
      tail -f "$LOGFILE"
    else
      echo "No log file found at $LOGFILE"
    fi
    exit 0
    ;;
  log-clear)
    if [ -f "$LOGFILE" ]; then
        : > "$LOGFILE"
        echo "Log file cleared: $LOGFILE"
    else
        echo "No log file found at $LOGFILE"
    fi
    exit 0
    ;;
  log-disable-all)
    echo "Disabling all logging and rotation..."
    sed -i '/^log_enabled=/c\log_enabled=0' "$CONF" 2>/dev/null || echo "log_enabled=0" >> "$CONF"
    reload_or_restart
    [ -f /etc/logrotate.d/sqm-autorate ] && mv /etc/logrotate.d/sqm-autorate /etc/logrotate.d/sqm-autorate.disabled
    echo "All logging and rotation disabled"
    exit 0
    ;;
  log-enable-all)
    echo "Enabling all logging and rotation..."
    sed -i '/^log_enabled=/c\log_enabled=1' "$CONF" 2>/dev/null || echo "log_enabled=1" >> "$CONF"
    reload_or_restart
    [ -f /etc/logrotate.d/sqm-autorate.disabled ] && mv /etc/logrotate.d/sqm-autorate.disabled /etc/logrotate.d/sqm-autorate
    echo "All logging and rotation enabled"
    exit 0
    ;;
esac

echo "=== SQM-AUTORATE SERVICE STATUS ==="
$SERVICE status 2>/dev/null || echo "Service script not found"

echo
echo "=== ACTIVE PROFILE ==="
if [ -f "$DEFAULT_FILE" ]; then
    echo "Default: $(cat $DEFAULT_FILE)"
fi
if [ -L "$CONF" ]; then
    ACTIVE_PATH=$(readlink -f $CONF)
    ACTIVE_PROFILE=$(basename "$ACTIVE_PATH" | sed 's/sqm-autorate-\(.*\)\.conf/\1/')
    echo "Active symlink: $ACTIVE_PATH"
    echo "Active profile: $ACTIVE_PROFILE"
else
    echo "Active config: $CONF"
fi

echo
echo "=== PROCESS UPTIME ==="
if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if [ -n "$PID" ] && [ -d "/proc/$PID" ]; then
        SYS_UP=$(awk '{print int($1)}' /proc/uptime)
        PROC_START=$(awk '{print $22}' /proc/$PID/stat)
        HZ=$(getconf CLK_TCK 2>/dev/null || echo 100)
        ELAPSED=$(( SYS_UP - (PROC_START / HZ) ))
        printf "PID %s has been running for %02d:%02d:%02d\n" \
            "$PID" $((ELAPSED/3600)) $((ELAPSED%3600/60)) $((ELAPSED%60))
    else
        echo "Process not running"
        rm -f "$PIDFILE"
    fi
else
    echo "No PID file found"
fi

echo
echo "=== LOGGING STATUS ==="
if grep -q '^log_enabled=1' "$CONF" 2>/dev/null; then
    echo "Logging: ENABLED"
elif grep -q '^log_enabled=0' "$CONF" 2>/dev/null; then
    echo "Logging: DISABLED"
else
    echo "Logging flag not found in $CONF"
fi

echo
echo "=== LOG VERBOSITY LEVEL ==="
case "$(grep -E '^log_level=' "$CONF" 2>/dev/null | cut -d= -f2)" in
  1) VERBOSITY="LEVEL 1 (minimal)" ;;
  2) VERBOSITY="LEVEL 2 (medium)" ;;
  3) VERBOSITY="LEVEL 3 (debug)" ;;
  *) VERBOSITY="not set" ;;
esac
echo "Verbosity: $VERBOSITY"

echo
echo "=== LOG FORMAT ==="
FORMAT=$(grep -E '^log_format=' "$CONF" 2>/dev/null | cut -d= -f2)
echo "Format: ${FORMAT:-not set}"

echo
echo "=== LOG MODE ==="
MODE=$(grep -E '^log_mode=' "$CONF" 2>/dev/null | cut -d= -f2)
case "$MODE" in
  0) echo "Mode: 0 (silent)" ;;
  1) echo "Mode: 1 (event-driven)" ;;
  2) echo "Mode: 2 (tick-driven)" ;;
  *) echo "Mode: not set" ;;
esac

echo
echo "=== REFLECTOR SETTINGS ==="
COUNT=$(grep -E '^reflector_count=' "$CONF" 2>/dev/null | cut -d= -f2)
ROTATION=$(grep -E '^reflector_rotation=' "$CONF" 2>/dev/null | cut -d= -f2)
echo "Reflector count: ${COUNT:-not set}"
echo "Reflector rotation: ${ROTATION:-not set}"

echo
echo "=== PROBE SETTINGS ==="
PMIN=$(grep -E '^probe_min_ms=' "$CONF" 2>/dev/null | cut -d= -f2)
SETUID=$(grep -E '^probe_setuid_fix=' "$CONF" 2>/dev/null | cut -d= -f2)
echo "Probe minimum interval: ${PMIN:-not set} ms"
echo "Probe setuid fix: $( [ "$SETUID" = "1" ] && echo ENABLED || echo DISABLED )"

echo
echo "=== LATENCY SMOOTHING ==="
ALPHAEWMA=$(grep -E '^alpha_ewma=' "$CONF" 2>/dev/null | cut -d= -f2)
echo "Alpha EWMA: ${ALPHAEWMA:-not set}"

echo
echo "=== LOG ROTATION STATUS ==="
if [ -f /etc/logrotate.d/sqm-autorate ] && [ -f /etc/logrotate.d/sqm-autorate.disabled ]; then
    echo "Rotation: inconsistent (both configs present)"
elif [ -f /etc/logrotate.d/sqm-autorate ]; then
    echo "Rotation: ENABLED"
elif [ -f /etc/logrotate.d/sqm-autorate.disabled ]; then
    echo "Rotation: DISABLED"
else
    echo "Rotation: config not found"
fi

echo
echo "=== LOG FILE SIZE ==="
if [ -f "$LOGFILE" ]; then
    ls -lh "$LOGFILE" | awk '{print $5 " (" $9 ")"}'
else
    echo "No log file found"
fi

echo
echo "=== LAST 20 LOG LINES ==="
if [ -f "$LOGFILE" ]; then
    tail -n 20 "$LOGFILE" || echo "(empty log file)"
else
    echo "No log file found at $LOGFILE"
fi

echo
echo "=== SUMMARY ==="
SUMMARY_DEFAULT=$(cat $DEFAULT_FILE 2>/dev/null || echo "unknown")
SUMMARY_ACTIVE=$(basename "$(readlink -f $CONF)" | sed 's/sqm-autorate-\(.*\)\.conf/\1/')
MODE=$(grep -E '^log_mode=' "$CONF" 2>/dev/null | cut -d= -f2)
case "$MODE" in
  0) MODE_DESC="0 (silent)" ;;
  1) MODE_DESC="1 (event-driven)" ;;
  2) MODE_DESC="2 (tick-driven)" ;;
  *) MODE_DESC="not set" ;;
esac
echo "Default profile: $SUMMARY_DEFAULT"
echo "Active profile: $SUMMARY_ACTIVE"
echo "Logging: $(grep -q '^log_enabled=1' "$CONF" 2>/dev/null && echo ENABLED || echo DISABLED)"
echo "Verbosity: $VERBOSITY"
echo "Format: ${FORMAT:-not set}"
echo "Mode: $MODE_DESC"
echo "Reflector count: ${COUNT:-not set}"
echo "Reflector rotation: ${ROTATION:-not set}"
echo "Probe minimum interval: ${PMIN:-not set} ms"
echo "Probe setuid fix: $( [ "$SETUID" = "1" ] && echo ENABLED || echo DISABLED )"
echo "Alpha EWMA: ${ALPHAEWMA:-not set}"

echo
echo "=== CONSISTENCY CHECK ==="
if [ -L "$CONF" ]; then
    ACTIVE_PROFILE=$(basename "$(readlink -f "$CONF")" | sed 's/sqm-autorate-\(.*\)\.conf/\1/')
    DEFAULT_PROFILE=$(cat "$DEFAULT_FILE" 2>/dev/null || echo "none")
    if [ "$ACTIVE_PROFILE" != "$DEFAULT_PROFILE" ] && [ "$DEFAULT_PROFILE" != "none" ]; then
        echo "WARNING: Active profile ($ACTIVE_PROFILE) differs from default ($DEFAULT_PROFILE)"
    else
        echo "Profiles consistent: Active=$ACTIVE_PROFILE, Default=$DEFAULT_PROFILE"
    fi
else
    echo "No symlink found for active config"
fi

if [ -f "$PIDFILE" ]; then
    PID=$(cat "$PIDFILE")
    if [ -n "$PID" ] && [ -d "/proc/$PID" ]; then
        echo "Daemon running with PID $PID"
    else
        echo "WARNING: PID file exists but process not running"
    fi
else
    echo "No PID file found"
fi

if [ -f /etc/logrotate.d/sqm-autorate ] && [ -f /etc/logrotate.d/sqm-autorate.disabled ]; then
    echo "WARNING: Both rotation configs present (inconsistent)"
fi
