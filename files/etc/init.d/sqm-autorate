#!/bin/sh /etc/rc.common
# Init script for sqm-autorate.pl using procd

START=99
STOP=10
REQUIRE="sqm"
USE_PROCD=1

SCRIPT="/usr/bin/sqm-autorate.pl"
CONFIG="/var/sqm-autorate.conf"       # runtime symlink target
PIDFILE="/var/run/sqm-autorate.pid"
LOGFILE="/var/log/sqm-autorate.log"

EXTRA_COMMANDS="status reload stop"
EXTRA_HELP="        status          Show if sqm-autorate is running
        reload          Send SIGHUP to reload config
        stop            Stop sqm-autorate cleanly"

# --- Helper: ensure active symlink ---
ensure_active_symlink() {
    DEFAULT_FILE="/etc/sqm-default"
    CONF_DIR="/etc/sqm-profiles"
    DEFAULT_LINK="$CONF_DIR/sqm-autorate-default.conf"
    ACTIVE="$CONFIG"

    # Respect existing symlink or file
    if [ -L "$ACTIVE" ] || [ -f "$ACTIVE" ]; then
        current=$(readlink -f "$ACTIVE" 2>/dev/null || echo "$ACTIVE")
        echo "sqm-autorate: using existing active config: $current"
        return 0
    fi

    # Otherwise create from default marker
    if [ -f "$DEFAULT_FILE" ]; then
        PROFILE=$(cat "$DEFAULT_FILE" | tr -d ' \t\r\n')
        TARGET="$CONF_DIR/sqm-autorate-$PROFILE.conf"

        if [ -f "$TARGET" ]; then
            [ -r "$TARGET" ] || { echo "sqm-autorate: profile file not readable: $TARGET"; return 1; }
            grep -q '^upload_base_kbits=' "$TARGET" 2>/dev/null || echo "sqm-autorate: warning: missing 'upload_base_kbits' in $TARGET"
            grep -q '^download_base_kbits=' "$TARGET" 2>/dev/null || echo "sqm-autorate: warning: missing 'download_base_kbits' in $TARGET"
            ln -sfn "$TARGET" "$ACTIVE"
            ln -sfn "$TARGET" "$DEFAULT_LINK"
            echo "sqm-autorate: loaded default profile '$PROFILE'"
            echo "Active symlink now points to: $(readlink -f "$ACTIVE")"
        else
            echo "sqm-autorate: default profile '$PROFILE' not found in $CONF_DIR"
        fi
    else
        echo "sqm-autorate: no default marker found ($DEFAULT_FILE)"
    fi
}

# --- Helper: check consistency between default and active ---
check_consistency() {
    DEFAULT_FILE="/etc/sqm-default"
    if [ -f "$DEFAULT_FILE" ] && [ -L "$CONFIG" ]; then
        def=$(cat "$DEFAULT_FILE" | tr -d ' \t\r\n')
        act=$(basename "$(readlink -f "$CONFIG")" | sed 's/sqm-autorate-\(.*\)\.conf/\1/')
        if [ "$def" != "$act" ]; then
            echo "sqm-autorate: WARNING default=$def active=$act (profiles differ)"
        else
            echo "sqm-autorate: profiles consistent (default=$def, active=$act)"
        fi
    fi
}

service_triggers() {
    procd_add_reload_trigger sqm-autorate
    procd_add_reload_trigger sqm
}

start_service() {
    if ! /etc/init.d/sqm status >/dev/null 2>&1; then
        echo "sqm-autorate: SQM not running, skipping start"
        return 1
    fi

    if ! ping -c1 -W1 8.8.8.8 >/dev/null 2>&1; then
        echo "sqm-autorate: no internet connectivity, skipping start"
        return 1
    fi

    # Ensure symlink exists before reading config
    ensure_active_symlink
    check_consistency

    # Read upload interface from active config
    UPLOAD_IF=$(grep '^upload_interface=' "$CONFIG" | cut -d= -f2)
    [ -z "$UPLOAD_IF" ] && UPLOAD_IF="eth0"

    for i in $(seq 1 50); do
        if tc qdisc show dev "$UPLOAD_IF" | grep -q nsstbl; then
            break
        fi
        sleep 1
    done

    procd_open_instance
    procd_set_param command "$SCRIPT"
    procd_set_param pidfile "$PIDFILE"
    procd_set_param respawn
    procd_set_param stdout 1
    procd_set_param stderr 1
    procd_set_param env CONFIG="$CONFIG" LOGFILE="$LOGFILE"
    procd_set_param file "$LOGFILE"
    procd_close_instance
}

status() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if [ -n "$PID" ] && [ -d "/proc/$PID" ]; then
            echo "sqm-autorate: running (PID $PID)"
            return 0
        fi
    fi
    echo "sqm-autorate: not running"
    return 1
}

reload_service() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if [ -n "$PID" ] && [ -d "/proc/$PID" ]; then
            kill -HUP "$PID" && echo "sqm-autorate: sent SIGHUP to PID $PID for config reload" && return 0
            echo "sqm-autorate: reload failed, restarting service"
            /etc/init.d/sqm-autorate restart
            return 1
        else
            echo "sqm-autorate: process not running, cannot reload"
            return 1
        fi
    else
        echo "sqm-autorate: no PID file found, cannot reload"
        return 1
    fi
}

stop_service() {
    if [ -f "$PIDFILE" ]; then
        PID=$(cat "$PIDFILE")
        if [ -n "$PID" ]; then
            kill "$PID" 2>/dev/null
            rm -f "$PIDFILE"
            echo "sqm-autorate: stopped (PID $PID)"
            return 0
        fi
    fi
    echo "sqm-autorate: no PID file, nothing to stop"
    return 1
}
